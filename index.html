<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SADK TRADER</title>
<meta name="theme-color" content="#0a0d12">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SADK TRADER">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
<link rel="shortcut icon" href="favicon.ico">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Inter:wght@400;600;700;900&family=Cinzel:wght@700;900&display=swap" rel="stylesheet">

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBq_6LE2Fwb-wmZek2JqqW61cqkYzj61xM",
  authDomain: "sadk-trader.firebaseapp.com",
  projectId: "sadk-trader",
  storageBucket: "sadk-trader.firebasestorage.app",
  messagingSenderId: "1016959968394",
  appId: "1:1016959968394:web:bde709783ff15eef95b973"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Expose DB helpers to global scope
window.firestore = {
  async setData(path, data) {
    const parts = path.split('/');
    const ref = doc(db, ...parts);
    await setDoc(ref, data, { merge: true });
  },
  async getData(path) {
    const parts = path.split('/');
    const ref = doc(db, ...parts);
    const snap = await getDoc(ref);
    return snap.exists() ? snap.data() : null;
  },
  async deleteData(path) {
    const parts = path.split('/');
    const ref = doc(db, ...parts);
    await deleteDoc(ref);
  }
};

window.dispatchEvent(new Event('firebase-ready'));
</script>

<style>
:root{--bg:#0a0d12;--surface:#111620;--surface2:#161c28;--border:#1e2a3d;--green:#00e5a0;--red:#ff4d6d;--gold:#f5c842;--blue:#4d9fff;--text:#e8edf5;--muted:#5a6a85;--font:'Inter',sans-serif;--mono:'IBM Plex Mono',monospace;}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;max-width:100%;overflow-x:hidden;background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;-webkit-text-size-adjust:100%;}

/* AUTH */
#auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;background:radial-gradient(ellipse at 60% 40%,#0d1f2d 0%,var(--bg) 70%);}
.auth-box{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px 20px;width:100%;max-width:400px;animation:fadeUp .5s ease;}
.auth-logo{text-align:center;margin-bottom:28px;}
.brand-emblem{width:64px;height:64px;margin:0 auto 14px;background:conic-gradient(from 135deg,#00e5a0,#4d9fff,#f5c842,#00e5a0);border-radius:18px;display:flex;align-items:center;justify-content:center;position:relative;animation:glow 3s ease-in-out infinite;}
.brand-emblem::before{content:'';position:absolute;inset:2px;background:var(--bg);border-radius:15px;}
.brand-emblem-inner{position:relative;z-index:1;font-size:26px;}
@keyframes glow{0%,100%{box-shadow:0 0 24px rgba(0,229,160,.35)}50%{box-shadow:0 0 44px rgba(0,229,160,.6),0 0 20px rgba(77,159,255,.3)}}
.brand-name{font-family:'Cinzel',serif;font-size:22px;font-weight:900;letter-spacing:5px;background:linear-gradient(135deg,#e8edf5 30%,#00e5a0 65%,#4d9fff 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.brand-tagline{font-family:var(--mono);font-size:10px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;margin-top:4px;}
.auth-tabs{display:flex;margin-bottom:24px;background:var(--bg);border-radius:10px;padding:4px;}
.auth-tab{flex:1;padding:9px;border:none;background:transparent;color:var(--muted);font-family:var(--font);font-size:14px;border-radius:8px;cursor:pointer;transition:all .2s;}
.auth-tab.active{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
.auth-form{display:flex;flex-direction:column;gap:14px;}
.auth-form label{font-size:12px;color:var(--muted);margin-bottom:4px;display:block;}
.auth-form input{width:100%;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:var(--font);font-size:15px;outline:none;transition:border-color .2s;}
.auth-form input:focus{border-color:var(--blue);}
.auth-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--green),var(--blue));border:none;border-radius:12px;color:#0a0d12;font-family:var(--font);font-size:16px;font-weight:900;cursor:pointer;margin-top:4px;transition:opacity .2s;}
.auth-btn:hover{opacity:.85;}
.auth-error{background:rgba(255,77,109,.1);border:1px solid rgba(255,77,109,.3);color:var(--red);border-radius:8px;padding:10px 14px;font-size:13px;display:none;text-align:center;}
.auth-success{background:rgba(0,229,160,.1);border:1px solid rgba(0,229,160,.3);color:var(--green);border-radius:8px;padding:10px 14px;font-size:13px;display:none;text-align:center;}

/* APP */
#app-screen{display:none;width:100%;overflow-x:hidden;}

/* HEADER */
header{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 14px;width:100%;display:flex;flex-direction:column;align-items:center;gap:8px;}
.hdr-top{width:100%;display:flex;align-items:center;justify-content:space-between;}
.header-brand{display:flex;align-items:center;gap:10px;}
.header-emblem{width:34px;height:34px;flex-shrink:0;background:conic-gradient(from 135deg,#00e5a0,#4d9fff,#f5c842,#00e5a0);border-radius:10px;display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 0 12px rgba(0,229,160,.3);}
.header-emblem::before{content:'';position:absolute;inset:2px;background:var(--surface);border-radius:8px;}
.header-emblem-inner{position:relative;z-index:1;font-size:14px;}
.header-brand-name{font-family:'Cinzel',serif;font-size:13px;font-weight:900;letter-spacing:2px;background:linear-gradient(135deg,#e8edf5,#00e5a0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.header-brand-sub{font-size:9px;color:var(--muted);font-family:var(--mono);letter-spacing:1px;}
.hdr-right{display:flex;align-items:center;gap:8px;}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;}
.sync-dot.syncing{background:var(--gold);animation:spin .8s linear infinite;}
.sync-dot.offline{background:var(--muted);animation:none;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.user-badge{display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:16px;padding:5px 10px;font-size:12px;}
.user-avatar{width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--green),var(--blue));display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#0a0d12;}
.logout-btn{background:none;border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:5px 10px;font-family:var(--font);font-size:11px;cursor:pointer;transition:all .2s;}
.logout-btn:hover{border-color:var(--red);color:var(--red);}
.account-bar{width:100%;display:flex;align-items:center;gap:6px;padding:0 2px;}
.acc-label{font-size:10px;color:var(--muted);white-space:nowrap;}
.acc-name{font-size:12px;font-weight:700;color:var(--gold);font-family:var(--mono);overflow:hidden;white-space:nowrap;max-width:130px;}
.acc-capital{font-size:10px;color:var(--muted);font-family:var(--mono);}

/* TABS */
.tabs{width:100%;display:flex;gap:3px;background:var(--bg);border-radius:10px;padding:3px;}
.tab{flex:1;padding:8px 4px;border-radius:8px;border:none;background:transparent;color:var(--muted);font-family:var(--font);font-size:12px;cursor:pointer;transition:all .2s;text-align:center;white-space:nowrap;}
.tab.active{background:var(--surface2);color:var(--text);border:1px solid var(--border);}

/* MAIN */
main{padding:12px;width:100%;}

/* STAT CARDS */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 12px;position:relative;overflow:hidden;animation:fadeUp .4s ease both;}
.stat-card::before{content:'';position:absolute;top:0;left:0;width:44px;height:44px;border-radius:0 0 44px 0;opacity:.1;}
.stat-card.green::before{background:var(--green)}.stat-card.red::before{background:var(--red)}.stat-card.gold::before{background:var(--gold)}.stat-card.blue::before{background:var(--blue)}
.stat-label{font-size:10px;color:var(--muted);margin-bottom:6px;line-height:1.3;}
.stat-value{font-size:18px;font-weight:900;font-family:var(--mono);line-height:1;}
.stat-value.green{color:var(--green)}.stat-value.red{color:var(--red)}.stat-value.gold{color:var(--gold)}.stat-value.blue{color:var(--blue)}
.stat-change{font-size:10px;margin-top:5px;color:var(--muted);font-family:var(--mono);}

/* CARDS */
.card,.full-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;animation:fadeUp .4s ease both;}
.card-title{font-size:13px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:7px;flex-wrap:wrap;}
.card-title .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}

/* CHART */
.chart-wrap{height:110px;width:100%;}
svg.chart{width:100%;height:100%;display:block;}

/* WIN RATE */
.win-rate-wrap{display:flex;align-items:center;gap:14px;}
.circle-wrap{position:relative;width:90px;height:90px;flex-shrink:0;}
.circle-wrap svg{transform:rotate(-90deg);width:90px;height:90px;}
.circle-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;}
.circle-center .pct{font-size:18px;font-weight:900;font-family:var(--mono);color:var(--green);}
.circle-center .lbl{font-size:9px;color:var(--muted);}
.win-stats{flex:1;min-width:0;}
.ws-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border);font-size:12px;}
.ws-row:last-child{border-bottom:none;}
.ws-row .ws-val{font-family:var(--mono);font-weight:600;font-size:11px;}

/* FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.form-group label{display:block;font-size:11px;color:var(--muted);margin-bottom:5px;}
.form-group input,.form-group select{width:100%;padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font);font-size:14px;outline:none;transition:border-color .2s;-webkit-appearance:none;}
.form-group input:focus,.form-group select:focus{border-color:var(--blue);}
.form-group select option{background:var(--surface2);}
.btn-add{width:100%;padding:13px;background:linear-gradient(135deg,var(--green),var(--blue));border:none;border-radius:10px;color:#0a0d12;font-family:var(--font);font-size:15px;font-weight:900;cursor:pointer;}

/* TRADE CARDS */
.trade-card{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:10px;margin-bottom:8px;background:var(--surface2);border:1px solid var(--border);gap:8px;}
.trade-card:last-child{margin-bottom:0;}
.trade-card.win-card{border-left:3px solid var(--green);}
.trade-card.loss-card{border-left:3px solid var(--red);}
.tc-left{display:flex;flex-direction:column;gap:3px;flex:1;min-width:0;}
.tc-asset{font-weight:700;font-size:14px;}
.tc-meta{font-size:10px;color:var(--muted);display:flex;gap:6px;flex-wrap:wrap;}
.tc-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;}
.tc-pnl{font-family:var(--mono);font-size:15px;font-weight:700;}
.tc-date{font-size:10px;color:var(--muted);font-family:var(--mono);}
.tc-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;padding:2px;}

/* CALENDAR */
.cal-day{border-radius:8px;padding:5px 3px;min-height:52px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:2px;border:1px solid var(--border);background:var(--surface2);cursor:pointer;transition:transform .15s;}
.cal-day:active{transform:scale(.96);}
.cal-day.empty{background:transparent;border-color:transparent;pointer-events:none;}
.cal-day.today{border-color:var(--blue);}
.cal-day.win{background:rgba(0,229,160,.1);border-color:rgba(0,229,160,.35);}
.cal-day.loss{background:rgba(255,77,109,.1);border-color:rgba(255,77,109,.35);}
.cal-day.selected{outline:2px solid var(--gold);outline-offset:1px;}
.cal-day-num{font-size:10px;color:var(--muted);font-family:var(--mono);margin-top:2px;}
.cal-day.today .cal-day-num{color:var(--blue);font-weight:700;}
.cal-pnl{font-size:9px;font-weight:700;font-family:var(--mono);text-align:center;line-height:1.2;}
.cal-day.win .cal-pnl{color:var(--green);}
.cal-day.loss .cal-pnl{color:var(--red);}
.cal-count{font-size:8px;color:var(--muted);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .2s ease;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-sheet{background:var(--surface);border-radius:20px 20px 0 0;border:1px solid var(--border);border-bottom:none;padding:20px 16px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;animation:slideUp .25s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
.modal-title{font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;}
.modal-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:0 4px;}
.acc-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;}
.acc-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-radius:10px;background:var(--surface2);border:1px solid var(--border);cursor:pointer;transition:all .2s;}
.acc-item.active-acc{border-color:var(--gold);background:rgba(245,200,66,.05);}
.acc-item-left{display:flex;flex-direction:column;gap:3px;}
.acc-item-name{font-size:14px;font-weight:700;}
.acc-item-capital{font-size:11px;color:var(--muted);font-family:var(--mono);}
.acc-item-right{display:flex;align-items:center;gap:8px;}
.acc-active-badge{font-size:9px;background:rgba(245,200,66,.15);color:var(--gold);border:1px solid rgba(245,200,66,.3);border-radius:10px;padding:2px 8px;}
.acc-del-btn{background:none;border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:4px 8px;font-size:11px;cursor:pointer;}
.acc-del-btn:hover{border-color:var(--red);color:var(--red);}
.add-acc-form{border-top:1px solid var(--border);padding-top:14px;display:flex;flex-direction:column;gap:10px;}
.add-acc-form h4{font-size:13px;color:var(--muted);margin-bottom:4px;}
.modal-input{width:100%;padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font);font-size:14px;outline:none;transition:border-color .2s;}
.modal-input:focus{border-color:var(--blue);}
.btn-create-acc{width:100%;padding:12px;background:linear-gradient(135deg,var(--green),var(--blue));border:none;border-radius:10px;color:#0a0d12;font-family:var(--font);font-size:14px;font-weight:700;cursor:pointer;}

.badge{display:inline-block;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700;}
.badge-buy{background:rgba(0,229,160,.12);color:var(--green)}
.badge-sell{background:rgba(255,77,109,.12);color:var(--red)}
.empty-msg{text-align:center;color:var(--muted);padding:24px 12px;font-size:13px;font-family:var(--font);}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* loading overlay */
#loading-overlay{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.loading-spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .8s linear infinite;}
.loading-text{font-size:12px;color:var(--muted);font-family:var(--mono);}
</style>
</head>
<body>

<!-- Loading -->
<div id="loading-overlay">
  <div class="brand-emblem" style="width:56px;height:56px;margin:0;"><div class="brand-emblem-inner">‚óà</div></div>
  <div class="loading-spinner"></div>
  <div class="loading-text">Connecting to cloud...</div>
</div>

<!-- AUTH -->
<div id="auth-screen" style="display:none">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="brand-emblem"><div class="brand-emblem-inner">‚óà</div></div>
      <div class="brand-name">SADK TRADER</div>
      <div class="brand-tagline">Performance Tracker</div>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Sign Up</button>
    </div>
    <div id="login-form" class="auth-form">
      <div><label>Username</label><input id="login-user" placeholder="Enter your username" autocomplete="username"/></div>
      <div><label>Password</label><input id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/></div>
      <div class="auth-error" id="login-error"></div>
      <button class="auth-btn" onclick="login()">Login</button>
    </div>
    <div id="register-form" class="auth-form" style="display:none">
      <div><label>Full Name</label><input id="reg-name" placeholder="Your full name"/></div>
      <div><label>Username</label><input id="reg-user" placeholder="Choose a unique username"/></div>
      <div><label>Password</label><input id="reg-pass" type="password" placeholder="At least 6 characters"/></div>
      <div class="auth-error" id="reg-error"></div>
      <div class="auth-success" id="reg-success"></div>
      <button class="auth-btn" onclick="register()">Create Account</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app-screen">
  <header>
    <div class="hdr-top">
      <div class="header-brand">
        <div class="header-emblem"><div class="header-emblem-inner">‚óà</div></div>
        <div>
          <div class="header-brand-name">SADK TRADER</div>
          <div class="header-brand-sub">Performance Tracker</div>
        </div>
      </div>
      <div class="hdr-right">
        <div class="sync-dot" id="sync-dot" title="Cloud sync"></div>
        <div class="user-badge">
          <div class="user-avatar" id="user-avatar">?</div>
          <span id="user-name-display">‚Äî</span>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    <div class="account-bar">
      <span class="acc-label">Account:</span>
      <span class="acc-name" id="active-acc-name">‚Äî</span>
      <span class="acc-capital" id="active-acc-capital"></span>
    </div>
    <div class="tabs">
      <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
      <button class="tab" onclick="switchTab('add')">‚ûï Add Trade</button>
      <button class="tab" onclick="openAccountModal()" style="flex:0.8">üë§ Accounts</button>
    </div>
  </header>

  <main>
    <!-- DASHBOARD -->
    <div id="tab-dashboard">
      <div class="stats-grid">
        <div class="stat-card green">
          <div class="stat-label">Total P&L</div>
          <div class="stat-value green" id="total-pnl">$0</div>
          <div class="stat-change" id="total-pnl-sub">0 trades</div>
        </div>
        <div class="stat-card blue">
          <div class="stat-label">Total Trades</div>
          <div class="stat-value blue" id="total-trades">0</div>
          <div class="stat-change" id="wl-count">0W / 0L</div>
        </div>
        <div class="stat-card gold">
          <div class="stat-label">Win Rate</div>
          <div class="stat-value gold" id="win-rate">0%</div>
          <div class="stat-change">Winning ratio</div>
        </div>
        <div class="stat-card blue">
          <div class="stat-label">Risk to Reward</div>
          <div class="stat-value blue" id="rr-card">‚Äî</div>
          <div class="stat-change">R:R Ratio</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title"><div class="dot" style="background:var(--green)"></div>Equity Curve</div>
        <div class="chart-wrap"><svg class="chart" id="equity-chart" viewBox="0 0 400 110" preserveAspectRatio="none"></svg></div>
      </div>

      <div class="card">
        <div class="card-title"><div class="dot" style="background:var(--gold)"></div>Performance Stats</div>
        <div class="win-rate-wrap">
          <div class="circle-wrap">
            <svg viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="40" fill="none" stroke="var(--border)" stroke-width="10"/>
              <circle cx="50" cy="50" r="40" fill="none" stroke="var(--green)" stroke-width="10"
                stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"
                id="win-arc" style="transition:stroke-dashoffset .8s ease"/>
            </svg>
            <div class="circle-center">
              <div class="pct" id="win-pct-circle">0%</div>
              <div class="lbl">Win Rate</div>
            </div>
          </div>
          <div class="win-stats">
            <div class="ws-row"><span>Avg Win</span><span class="ws-val" style="color:var(--green)" id="avg-win">$0</span></div>
            <div class="ws-row"><span>Avg Loss</span><span class="ws-val" style="color:var(--red)" id="avg-loss">$0</span></div>
            <div class="ws-row"><span>Risk to Reward</span><span class="ws-val" style="color:var(--blue)" id="rr-ratio">‚Äî</span></div>
            <div class="ws-row"><span>Best Trade</span><span class="ws-val" style="color:var(--green)" id="best-trade">$0</span></div>
          </div>
        </div>
      </div>

      <!-- CALENDAR -->
      <div class="full-card">
        <div class="card-title" style="justify-content:space-between;margin-bottom:10px;">
          <div style="display:flex;align-items:center;gap:7px;"><div class="dot" style="background:var(--blue)"></div>Monthly Calendar</div>
          <div style="display:flex;align-items:center;gap:8px;">
            <button onclick="changeMonth(-1)" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:3px 10px;cursor:pointer;font-size:14px;">‚Äπ</button>
            <span id="cal-month-label" style="font-family:var(--mono);font-size:11px;min-width:90px;text-align:center;"></span>
            <button onclick="changeMonth(1)" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:3px 10px;cursor:pointer;font-size:14px;">‚Ä∫</button>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:3px;">
          <div style="text-align:center;font-size:9px;color:var(--muted);padding:4px 0;">Su</div><div style="text-align:center;font-size:9px;color:var(--muted);padding:4px 0;">Mo</div><div style="text-align:center;font-size:9px;color:var(--muted);padding:4px 0;">Tu</div><div style="text-align:center;font-size:9px;color:var(--muted);padding:4px 0;">We</div><div style="text-align:center;font-size:9px;color:var(--muted);padding:4px 0;">Th</div><div style="text-align:center;font-size:9px;color:var(--muted);padding:4px 0;">Fr</div><div style="text-align:center;font-size:9px;color:var(--muted);padding:4px 0;">Sa</div>
        </div>
        <div id="cal-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;"></div>
      </div>

      <!-- RECENT TRADES -->
      <div class="full-card">
        <div class="card-title"><div class="dot" style="background:var(--blue)"></div><span id="recent-trades-title">Recent Trades</span></div>
        <div id="trades-table-body"><div class="empty-msg">No trades yet</div></div>
      </div>
    </div>

    <!-- ADD TRADE -->
    <div id="tab-add" style="display:none">
      <div class="full-card">
        <div class="card-title"><div class="dot" style="background:var(--green)"></div>Add New Trade</div>
        <div id="no-account-msg" style="display:none;text-align:center;padding:20px;color:var(--muted);">
          ‚ö†Ô∏è Please create or select an account first<br><br>
          <button onclick="openAccountModal()" style="background:linear-gradient(135deg,var(--green),var(--blue));border:none;border-radius:10px;color:#0a0d12;padding:10px 20px;font-weight:700;cursor:pointer;font-family:var(--font);">Manage Accounts</button>
        </div>
        <div id="add-trade-form">
          <div class="form-grid">
            <div class="form-group"><label>Asset</label>
              <select id="f-pair"><option value="Nasdaq">Nasdaq</option><option value="Gold">Gold</option></select>
            </div>
            <div class="form-group"><label>Type</label>
              <select id="f-type"><option value="buy">Buy</option><option value="sell">Sell</option></select>
            </div>
            <div class="form-group"><label>Closing Method</label>
              <select id="f-close"><option value="TP">TP</option><option value="SL">SL</option><option value="Manual Closing">Manual Closing</option></select>
            </div>
            <div class="form-group"><label>Lot Size</label><input id="f-size" type="number" placeholder="1.0" step="0.01" inputmode="decimal"/></div>
            <div class="form-group"><label>P&L ($)</label><input id="f-pnl" type="number" placeholder="150" inputmode="decimal"/></div>
            <div class="form-group"><label>Date</label><input id="f-date" type="date"/></div>
            <div class="form-group" style="grid-column:1/-1;">
              <label>Result</label>
              <div style="display:flex;gap:10px;margin-top:4px;">
                <button type="button" id="btn-win" onclick="setResult('win')" style="flex:1;padding:11px;border-radius:8px;border:2px solid var(--green);background:rgba(0,229,160,.15);color:var(--green);font-family:var(--font);font-size:14px;font-weight:700;cursor:pointer;">‚úÖ Win</button>
                <button type="button" id="btn-loss" onclick="setResult('loss')" style="flex:1;padding:11px;border-radius:8px;border:2px solid var(--border);background:transparent;color:var(--muted);font-family:var(--font);font-size:14px;font-weight:700;cursor:pointer;">‚ùå Loss</button>
              </div>
              <input type="hidden" id="f-result" value="win"/>
            </div>
          </div>
          <div class="form-group" style="margin-bottom:14px;">
            <label>Notes</label>
            <input id="f-notes" placeholder="Strategy, reason for entry..." style="width:100%;padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font);font-size:14px;outline:none;"/>
          </div>
          <button class="btn-add" onclick="addTrade()">+ Add Trade</button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- CONFIRM MODAL -->
<div id="confirm-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:2000;align-items:center;justify-content:center;padding:20px;">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;width:100%;max-width:320px;animation:fadeUp .2s ease;">
    <div style="font-size:22px;text-align:center;margin-bottom:12px;">‚ö†Ô∏è</div>
    <div id="confirm-msg" style="font-size:14px;text-align:center;color:var(--text);margin-bottom:20px;line-height:1.5;"></div>
    <div style="display:flex;gap:10px;">
      <button onclick="closeConfirm()" style="flex:1;padding:11px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:var(--font);font-size:14px;cursor:pointer;">Cancel</button>
      <button id="confirm-ok-btn" style="flex:1;padding:11px;border-radius:8px;border:none;background:var(--red);color:#fff;font-family:var(--font);font-size:14px;font-weight:700;cursor:pointer;">Delete</button>
    </div>
  </div>
</div>

<!-- ACCOUNT MODAL -->
<div id="account-modal" style="display:none">
  <div class="modal-overlay" onclick="closeModalIfOutside(event)">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-title">üë§ Manage Accounts <button class="modal-close" onclick="closeAccountModal()">‚úï</button></div>
      <div class="acc-list" id="acc-list"></div>
      <div class="add-acc-form">
        <h4>+ New Account</h4>
        <input class="modal-input" id="new-acc-name" placeholder="Account name (e.g. Live, Demo, Prop)"/>
        <input class="modal-input" id="new-acc-capital" type="number" placeholder="Starting capital ($)" inputmode="decimal"/>
        <button class="btn-create-acc" onclick="createAccount()">Create Account</button>
      </div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let currentUser=null, trades=[], accounts=[], activeAccountId=null;
let dbReady=false;

// ‚îÄ‚îÄ WAIT FOR FIREBASE ‚îÄ‚îÄ
window.addEventListener('firebase-ready', ()=>{
  dbReady=true;
  init();
});
// Fallback if firebase-ready already fired
setTimeout(()=>{ if(!dbReady){ dbReady=true; init(); } }, 3000);

// ‚îÄ‚îÄ FIREBASE HELPERS ‚îÄ‚îÄ
async function dbSet(path, data){
  try{ if(window.firestore) await window.firestore.setData(path, data); }
  catch(e){ console.warn('Cloud save failed:', e); }
}
async function dbGet(path){
  try{ if(window.firestore) return await window.firestore.getData(path); }
  catch(e){ console.warn('Cloud load failed:', e); }
  return null;
}
async function dbDelete(path){
  try{ if(window.firestore) await window.firestore.deleteData(path); }
  catch(e){ console.warn('Cloud delete failed:', e); }
}

// ‚îÄ‚îÄ SYNC DOT ‚îÄ‚îÄ
function setSyncing(s){
  const dot=document.getElementById('sync-dot');
  if(!dot)return;
  dot.className='sync-dot'+(s?' syncing':'');
  dot.title=s?'Syncing...':'Saved to cloud ‚òÅÔ∏è';
}
function setSynced(){setSyncing(false);}

// ‚îÄ‚îÄ LOCAL STORAGE (offline backup) ‚îÄ‚îÄ
function usersLocal(){try{return JSON.parse(localStorage.getItem('tl_users')||'{}')}catch{return{}}}
function saveUsersLocal(u){localStorage.setItem('tl_users',JSON.stringify(u))}

// ‚îÄ‚îÄ CONFIRM MODAL ‚îÄ‚îÄ
let confirmCallback=null;
function showConfirm(msg,onOk){
  confirmCallback=onOk;
  document.getElementById('confirm-msg').textContent=msg;
  document.getElementById('confirm-modal').style.display='flex';
  document.getElementById('confirm-ok-btn').onclick=()=>{
    const cb=confirmCallback;
    closeConfirm();
    if(cb)cb();
  };
}
function closeConfirm(){
  document.getElementById('confirm-modal').style.display='none';
  confirmCallback=null;
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
function switchAuthTab(t){
  document.getElementById('login-form').style.display=t==='login'?'flex':'none';
  document.getElementById('register-form').style.display=t==='register'?'flex':'none';
  document.querySelectorAll('.auth-tab').forEach((b,i)=>b.classList.toggle('active',(i===0&&t==='login')||(i===1&&t==='register')));
}
function showErr(id,msg){const e=document.getElementById(id);e.textContent=msg;e.style.display='block';setTimeout(()=>e.style.display='none',4000);}
function showOk(id,msg){const e=document.getElementById(id);e.textContent=msg;e.style.display='block';}

async function register(){
  const name=document.getElementById('reg-name').value.trim();
  const user=document.getElementById('reg-user').value.trim().toLowerCase();
  const pass=document.getElementById('reg-pass').value;
  if(!name||!user||!pass)return showErr('reg-error','Please fill in all fields');
  if(user.length<3)return showErr('reg-error','Username must be at least 3 characters');
  if(pass.length<6)return showErr('reg-error','Password must be at least 6 characters');

  // Check if user exists in Firestore
  const existing=await dbGet(`users/${user}`);
  if(existing)return showErr('reg-error','Username already exists');

  const userData={name, hash:btoa(unescape(encodeURIComponent(pass))), created:new Date().toISOString()};
  await dbSet(`users/${user}`, userData);
  // Also save locally
  const local=usersLocal(); local[user]=userData; saveUsersLocal(local);

  showOk('reg-success','‚úÖ Account created! You can log in now');
  setTimeout(()=>switchAuthTab('login'),1500);
}

async function login(){
  const user=document.getElementById('login-user').value.trim().toLowerCase();
  const pass=document.getElementById('login-pass').value;
  if(!user||!pass)return showErr('login-error','Please enter your credentials');

  setSyncing(true);
  // Try Firestore first, fallback to local
  let userData=await dbGet(`users/${user}`);
  if(!userData){
    const local=usersLocal();
    userData=local[user]||null;
  }
  setSynced();

  if(!userData)return showErr('login-error','Username not found');
  if(decodeURIComponent(escape(atob(userData.hash)))!==pass)return showErr('login-error','Incorrect password');

  currentUser={username:user, name:userData.name};
  localStorage.setItem('tl_session',JSON.stringify(currentUser));
  await enterApp();
}

async function enterApp(){
  document.getElementById('auth-screen').style.display='none';
  document.getElementById('app-screen').style.display='block';
  document.getElementById('user-name-display').textContent=currentUser.name;
  document.getElementById('user-avatar').textContent=currentUser.name.charAt(0).toUpperCase();
  document.getElementById('f-date').valueAsDate=new Date();

  // Load accounts from Firestore
  setSyncing(true);
  const accData=await dbGet(`users/${currentUser.username}/data/accounts`);
  accounts=accData?.list||[];
  setSynced();

  // Restore last active account
  const savedId=localStorage.getItem('tl_active_'+currentUser.username);
  if(savedId&&accounts.find(a=>a.id===savedId)) activeAccountId=savedId;
  else if(accounts.length) activeAccountId=accounts[0].id;
  else activeAccountId=null;

  await loadActiveAccountTrades();
  updateAccountBar();
  updateDashboard();
}

async function loadActiveAccountTrades(){
  if(!activeAccountId){trades=[];return;}
  setSyncing(true);
  const data=await dbGet(`users/${currentUser.username}/accounts/${activeAccountId}`);
  trades=data?.trades||[];
  setSynced();
}

function logout(){
  currentUser=null;trades=[];accounts=[];activeAccountId=null;
  localStorage.removeItem('tl_session');
  document.getElementById('app-screen').style.display='none';
  document.getElementById('auth-screen').style.display='flex';
  document.getElementById('login-user').value='';
  document.getElementById('login-pass').value='';
}

// ‚îÄ‚îÄ ACCOUNTS ‚îÄ‚îÄ
function openAccountModal(){renderAccountList();document.getElementById('account-modal').style.display='block';}
function closeAccountModal(){document.getElementById('account-modal').style.display='none';}
function closeModalIfOutside(e){if(e.target===e.currentTarget)closeAccountModal();}

function renderAccountList(){
  const list=document.getElementById('acc-list');
  if(!accounts.length){list.innerHTML='<div class="empty-msg" style="padding:12px">No accounts yet ‚Äî create one below</div>';return;}
  list.innerHTML=accounts.map(acc=>`
    <div class="acc-item ${acc.id===activeAccountId?'active-acc':''}" onclick="selectAccount('${acc.id}')">
      <div class="acc-item-left">
        <div class="acc-item-name">${acc.name}</div>
        <div class="acc-item-capital">Capital: $${Number(acc.capital).toLocaleString()}</div>
      </div>
      <div class="acc-item-right">
        ${acc.id===activeAccountId?'<span class="acc-active-badge">‚óè Active</span>':''}
        <button class="acc-del-btn" onclick="event.stopPropagation();deleteAccount('${acc.id}')">Delete</button>
      </div>
    </div>`).join('');
}

async function saveAccountsToCloud(){
  setSyncing(true);
  await dbSet(`users/${currentUser.username}/data/accounts`,{list:accounts});
  setSynced();
}

async function createAccount(){
  const name=document.getElementById('new-acc-name').value.trim();
  const capital=parseFloat(document.getElementById('new-acc-capital').value)||0;
  if(!name)return alert('Please enter an account name');
  const acc={id:'acc_'+Date.now(),name,capital,created:new Date().toISOString()};
  accounts.push(acc);
  await saveAccountsToCloud();
  document.getElementById('new-acc-name').value='';
  document.getElementById('new-acc-capital').value='';
  if(accounts.length===1) await selectAccount(acc.id,false);
  renderAccountList();
}

async function selectAccount(id,closeModal=true){
  activeAccountId=id;
  localStorage.setItem('tl_active_'+currentUser.username,id);
  await loadActiveAccountTrades();
  updateAccountBar();
  updateDashboard();
  if(closeModal)closeAccountModal();
  renderAccountList();
}

async function deleteAccount(id){
  showConfirm('Delete this account and all its trades? This cannot be undone.', async()=>{
    accounts=accounts.filter(a=>a.id!==id);
    // Delete trades from Firestore
    await dbDelete(`users/${currentUser.username}/accounts/${id}`);
    await saveAccountsToCloud();
    if(activeAccountId===id){
      activeAccountId=accounts.length?accounts[0].id:null;
      if(activeAccountId) localStorage.setItem('tl_active_'+currentUser.username,activeAccountId);
      else localStorage.removeItem('tl_active_'+currentUser.username);
      await loadActiveAccountTrades();
      updateAccountBar();
      updateDashboard();
    }
    renderAccountList();
  });
}

function updateAccountBar(){
  const acc=accounts.find(a=>a.id===activeAccountId);
  document.getElementById('active-acc-name').textContent=acc?acc.name:'No Account';
  document.getElementById('active-acc-capital').textContent=acc?'($'+Number(acc.capital).toLocaleString()+')':'';
  const hasAcc=!!activeAccountId&&!!acc;
  document.getElementById('no-account-msg').style.display=hasAcc?'none':'block';
  document.getElementById('add-trade-form').style.display=hasAcc?'block':'none';
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchTab(t){
  ['dashboard','add'].forEach(id=>document.getElementById('tab-'+id).style.display=(id===t)?'block':'none');
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  if(t==='dashboard')document.querySelector('.tab:nth-child(1)').classList.add('active');
  if(t==='add')document.querySelector('.tab:nth-child(2)').classList.add('active');
}

// ‚îÄ‚îÄ RESULT ‚îÄ‚îÄ
function setResult(r){
  document.getElementById('f-result').value=r;
  const wb=document.getElementById('btn-win'),lb=document.getElementById('btn-loss');
  const base='flex:1;padding:11px;border-radius:8px;font-family:var(--font);font-size:14px;font-weight:700;cursor:pointer;';
  if(r==='win'){
    wb.style.cssText=base+'border:2px solid var(--green);background:rgba(0,229,160,.15);color:var(--green);';
    lb.style.cssText=base+'border:2px solid var(--border);background:transparent;color:var(--muted);';
  }else{
    lb.style.cssText=base+'border:2px solid var(--red);background:rgba(255,77,109,.15);color:var(--red);';
    wb.style.cssText=base+'border:2px solid var(--border);background:transparent;color:var(--muted);';
  }
}

// ‚îÄ‚îÄ TRADES ‚îÄ‚îÄ
async function saveTrades(){
  setSyncing(true);
  await dbSet(`users/${currentUser.username}/accounts/${activeAccountId}`,{trades});
  setSynced();
}

async function addTrade(){
  if(!activeAccountId)return alert('Please select an account first');
  const pair=document.getElementById('f-pair').value;
  const type=document.getElementById('f-type').value;
  const closing=document.getElementById('f-close').value;
  const size=parseFloat(document.getElementById('f-size').value)||1;
  const pnl=parseFloat(document.getElementById('f-pnl').value);
  const result=document.getElementById('f-result').value;
  const date=document.getElementById('f-date').value||new Date().toISOString().split('T')[0];
  const notes=document.getElementById('f-notes').value;
  if(isNaN(pnl))return alert('Please enter the P&L amount');
  trades.push({id:Date.now(),pair,type,closing,size,pnl,result,date,notes});
  await saveTrades();
  ['f-size','f-pnl','f-notes'].forEach(id=>document.getElementById(id).value='');
  setResult('win');
  updateDashboard();
  switchTab('dashboard');
}

async function deleteTrade(id){
  trades=trades.filter(t=>t.id!==id);
  await saveTrades();
  updateDashboard();
}

function fmt(v){return(v>=0?'+ $':'- $')+Math.round(Math.abs(v)).toLocaleString();}
function fmtTrade(t){return(t.result==='win'?'+ $':'- $')+Math.round(Math.abs(t.pnl)).toLocaleString();}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function updateDashboard(){
  const wins=trades.filter(t=>t.result==='win');
  const losses=trades.filter(t=>t.result==='loss');
  const totalPnl=trades.reduce((s,t)=>t.result==='win'?s+Math.abs(t.pnl):s-Math.abs(t.pnl),0);
  const winRate=trades.length?(wins.length/trades.length*100):0;
  const avgWin=wins.length?wins.reduce((s,t)=>s+Math.abs(t.pnl),0)/wins.length:0;
  const avgLoss=losses.length?losses.reduce((s,t)=>s+Math.abs(t.pnl),0)/losses.length:0;
  const bestTrade=wins.length?Math.max(...wins.map(t=>Math.abs(t.pnl))):0;
  const rrRaw=avgLoss?(avgWin/avgLoss):0;
  const rr=avgLoss?'1:'+rrRaw.toFixed(1):'‚Äî';

  const pnlEl=document.getElementById('total-pnl');
  pnlEl.textContent=fmt(totalPnl);
  pnlEl.className='stat-value '+(totalPnl>=0?'green':'red');
  pnlEl.closest('.stat-card').className='stat-card '+(totalPnl>=0?'green':'red');
  document.getElementById('total-pnl-sub').textContent=trades.length+' trades';
  document.getElementById('total-trades').textContent=trades.length;
  document.getElementById('wl-count').textContent=`${wins.length}W / ${losses.length}L`;
  document.getElementById('win-rate').textContent=winRate.toFixed(0)+'%';
  document.getElementById('rr-card').textContent=rr;
  document.getElementById('avg-win').textContent='+ $'+Math.round(avgWin).toLocaleString();
  document.getElementById('avg-loss').textContent='- $'+Math.round(avgLoss).toLocaleString();
  document.getElementById('rr-ratio').textContent=rr;
  document.getElementById('best-trade').textContent='+ $'+Math.round(bestTrade).toLocaleString();
  document.getElementById('win-pct-circle').textContent=winRate.toFixed(0)+'%';
  const arc=document.getElementById('win-arc');
  arc.setAttribute('stroke',winRate>=50?'var(--green)':'var(--red)');
  arc.setAttribute('stroke-dashoffset',251.2-(251.2*winRate/100));
  renderRecentTrades(); drawEquityChart(); renderCalendar();
}

// ‚îÄ‚îÄ RECENT TRADES ‚îÄ‚îÄ
let activeCalDay=null;
function renderRecentTrades(filterDate=null){
  const container=document.getElementById('trades-table-body');
  const titleEl=document.getElementById('recent-trades-title');
  let list=[...trades].sort((a,b)=>{if(b.date!==a.date)return b.date.localeCompare(a.date);return b.id-a.id;});
  if(filterDate){
    list=list.filter(t=>t.date===filterDate);
    if(titleEl)titleEl.innerHTML=`<span style="color:var(--blue);font-family:var(--mono)">${filterDate}</span>
      <button onclick="clearCalFilter()" style="margin-left:8px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:2px 8px;cursor:pointer;font-size:11px;">‚úï Clear</button>`;
  }else{
    list=list.slice(0,8);
    if(titleEl)titleEl.textContent='Recent Trades';
  }
  if(!list.length){container.innerHTML=`<div class="empty-msg">${filterDate?'No trades on this day':'No trades yet ‚Äî add your first trade!'}</div>`;return;}
  container.innerHTML=list.map(t=>`
    <div class="trade-card ${t.result==='win'?'win-card':'loss-card'}">
      <div class="tc-left">
        <div class="tc-asset">${t.pair} <span class="badge ${t.type==='buy'?'badge-buy':'badge-sell'}" style="font-size:9px">${t.type==='buy'?'Buy':'Sell'}</span></div>
        <div class="tc-meta">
          <span>${t.closing||'‚Äî'}</span>
          <span style="color:${t.result==='win'?'var(--green)':'var(--red)'}">${t.result==='win'?'‚úÖ Win':'‚ùå Loss'}</span>
          <span>Lot: ${t.size}</span>
        </div>
      </div>
      <div class="tc-right">
        <div class="tc-pnl" style="color:${t.result==='win'?'var(--green)':'var(--red)'}">${fmtTrade(t)}</div>
        <div class="tc-date">${t.date}</div>
        <button class="tc-del" onclick="deleteTrade(${t.id})">‚úï</button>
      </div>
    </div>`).join('');
}
function clearCalFilter(){
  activeCalDay=null;
  document.querySelectorAll('.cal-day.selected').forEach(c=>c.classList.remove('selected'));
  renderRecentTrades();
}

// ‚îÄ‚îÄ EQUITY CHART ‚îÄ‚îÄ
function drawEquityChart(){
  const svg=document.getElementById('equity-chart');
  if(!trades.length){svg.innerHTML='';return;}
  const sorted=[...trades].sort((a,b)=>a.date.localeCompare(b.date)||(a.id-b.id));
  let eq=0;const pts=[{x:0,y:0}];
  sorted.forEach((t,i)=>{eq+=t.result==='win'?Math.abs(t.pnl):-Math.abs(t.pnl);pts.push({x:i+1,y:eq});});
  const isPos=eq>=0,W=400,H=110,pad=14;
  const minY=Math.min(...pts.map(p=>p.y)),maxY=Math.max(...pts.map(p=>p.y));
  const rY=maxY-minY||1,rX=pts.length-1||1;
  const px=x=>pad+(x/rX)*(W-pad*2);
  const py=y=>H-pad-((y-minY)/rY)*(H-pad*2);
  const p=pts.map(pt=>`${px(pt.x)},${py(pt.y)}`).join(' ');
  const f=`${px(0)},${H-pad} ${p} ${px(pts.length-1)},${H-pad}`;
  svg.innerHTML=`<defs><linearGradient id="cg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${isPos?'#00e5a0':'#ff4d6d'}" stop-opacity=".3"/><stop offset="100%" stop-color="${isPos?'#00e5a0':'#ff4d6d'}" stop-opacity="0"/></linearGradient></defs>
  <polygon points="${f}" fill="url(#cg)"/>
  <polyline points="${p}" fill="none" stroke="${isPos?'var(--green)':'var(--red)'}" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
  ${pts.map((pt,i)=>i===pts.length-1?`<circle cx="${px(pt.x)}" cy="${py(pt.y)}" r="3.5" fill="${isPos?'var(--green)':'var(--red)'}"/>`:'').join('')}`;
}

// ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ
let calDate=new Date();
function changeMonth(dir){calDate=new Date(calDate.getFullYear(),calDate.getMonth()+dir,1);renderCalendar();}
function renderCalendar(){
  const year=calDate.getFullYear(),month=calDate.getMonth(),today=new Date();
  document.getElementById('cal-month-label').textContent=new Date(year,month,1).toLocaleString('en',{month:'short',year:'numeric'});
  const dayMap={};
  trades.forEach(t=>{
    if(!t.date)return;
    const[ty,tm,td]=t.date.split('-').map(Number);
    if(ty!==year||tm-1!==month)return;
    if(!dayMap[td])dayMap[td]={pnl:0,count:0};
    dayMap[td].pnl+=t.result==='win'?Math.abs(t.pnl):-Math.abs(t.pnl);
    dayMap[td].count++;
  });
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const grid=document.getElementById('cal-grid');
  grid.innerHTML='';
  for(let i=0;i<firstDay;i++){const e=document.createElement('div');e.className='cal-day empty';grid.appendChild(e);}
  for(let d=1;d<=daysInMonth;d++){
    const cell=document.createElement('div');
    const isToday=today.getDate()===d&&today.getMonth()===month&&today.getFullYear()===year;
    const data=dayMap[d];
    cell.className='cal-day'+(isToday?' today':'')+(data?(data.pnl>=0?' win':' loss'):'');
    const numEl=document.createElement('div');numEl.className='cal-day-num';numEl.textContent=d;cell.appendChild(numEl);
    if(data){
      const pnlEl=document.createElement('div');pnlEl.className='cal-pnl';
      pnlEl.textContent=(data.pnl>=0?'+':'-')+'$'+Math.round(Math.abs(data.pnl)).toLocaleString();
      cell.appendChild(pnlEl);
      const cEl=document.createElement('div');cEl.className='cal-count';cEl.textContent=data.count+'t';cell.appendChild(cEl);
    }
    const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    cell.addEventListener('click',()=>{
      if(activeCalDay===dateStr){activeCalDay=null;cell.classList.remove('selected');renderRecentTrades();}
      else{
        document.querySelectorAll('.cal-day.selected').forEach(c=>c.classList.remove('selected'));
        activeCalDay=dateStr;cell.classList.add('selected');renderRecentTrades(dateStr);
        document.getElementById('trades-table-body').closest('.full-card').scrollIntoView({behavior:'smooth',block:'start'});
      }
    });
    grid.appendChild(cell);
  }
}

// ‚îÄ‚îÄ SERVICE WORKER ‚îÄ‚îÄ
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js')
      .then(r=>console.log('SW OK'))
      .catch(e=>console.log('SW fail',e));
  });
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
async function init(){
  document.getElementById('loading-overlay').style.display='none';
  const s=localStorage.getItem('tl_session');
  if(s){
    try{
      currentUser=JSON.parse(s);
      document.getElementById('auth-screen').style.display='none';
      await enterApp();
    }catch{
      localStorage.removeItem('tl_session');
      document.getElementById('auth-screen').style.display='flex';
    }
  } else {
    document.getElementById('auth-screen').style.display='flex';
  }
}
</script>
</body>
</html>
